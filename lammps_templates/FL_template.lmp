kim init ${modelname} metal unit_conversion_mode

# periodic boundary conditions along all three dimensions
boundary p p p

# Read crystal equilibrium crystal.
read_data output/equilibrium_crystal.dump


# Convert box and all atomic positions to the correct units.
#change_box all x scale ${_u_distance} &
#               y scale ${_u_distance} &
#               z scale ${_u_distance} &
#               xy final $(xy*v__u_distance) &
#               xz final $(xz*v__u_distance) &
#               yz final $(yz*v__u_distance) &
#               remap

# Interatomic potential and neighbor settings
kim           interactions ${species}

# set the time step to 0.001 picoseconds
variable timestep_converted equal ${timestep}*${_u_time}
timestep ${timestep_converted}

variable temp_converted equal ${temperature}*${_u_temperature}
variable Tdamp_converted equal ${temperature_damping}*${_u_time}

# create initial velocities consistent with the chosen temperature
velocity      all create ${temp_converted} ${temperature_seed}

# Frenkel-Ladd fix
fix           FL all ti/spring ${spring_constant} ${t_switch} ${t_equil} function 2
#fix           FL2 all ti/spring ${spring_constant_2} ${t_switch} ${t_equil} function 2

# set NVT ensemble for all atoms
fix           ensemble all nvt temp ${temp_converted} ${temp_converted} ${Tdamp_converted}
compute       cl all temp/com
fix_modify    ensemble temp cl

# print data to logfile every 1000 timesteps
variable      etotal_metal equal etotal/${_u_energy}
variable      pe_metal equal pe/${_u_energy}
variable      T_metal equal temp/${_u_temperature}
variable      P_metal equal press/${_u_pressure}

thermo_style  custom step etotal v_etotal_metal pe v_pe_metal &
              temp v_T_metal press v_P_metal
thermo        1000

# run equil 1
run ${t_equil}

# run switch 1
fix           record all print 1 "$(pe/atoms) $(f_FL/atoms) $(f_FL[1])" &
              title "# PE_potential [eV/atom] | PE_FL [eV/atom] | lambda" &
              screen no file ${switch1_output_file}
run ${t_switch}
unfix record

# run equil 2
run ${t_equil}

# run switch 2
fix           record all print 1 "$(pe/atoms) $(f_FL/atoms) $(f_FL[1])" &
              title "# PE_potential [eV/atom] | PE_FL [eV/atom] | lambda" &
              screen no file ${switch2_output_file}
run ${t_switch}
unfix record

print "LAMMPS calculation completed"
quit 0
